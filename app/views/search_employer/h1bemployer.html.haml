%script{:src => "https://www.google.com/jsapi", :type => "text/javascript"}

- require 'gchart'
.container-fluid	
	.row.search-page-main
		=render "layouts/nav-link-search-secondary"
		.row.first-row			
			.span12.show-search-tab-box
				.row
					= form_tag :search_employer_h1bemployer, :method => :get, :name=>"search_form" do
						.row
							.span6.offset2{:style=>"margin-top: 40px;"}
								.input-append									
									= text_field_tag :h1bemp_name, params[:h1bemp_name], :autocomplete => search_employer_autocomplete_h1bemp_name_path, :placeholder => "Employer Name", :value=> params[:h1bemp_name].presence || ""
									%a{:class=>"m-btn blue", :style => "margin-top: 0px; padding: 8px 14px", :href =>"javascript:search_form.submit();"}
										%i{:class=>"icon-search"}
										Search
				-if @search_h1bemp.present?
					.row		
						#content
							%ul#tabs.nav.nav-tabs{"data-tabs" => "tabs"}
								%li.active
									%a{"data-toggle" => "tab", :href => "#overview"} Overview
								%li
									%a{"data-toggle" => "tab", :href => "#h1b_gcstats"} H-1B / GC Stats
								%li
									%a{"data-toggle" => "tab", :href => "#top_jobs"} Top Jobs
								%li
									%a{"data-toggle" => "tab", :href => "#reviews"} Reviews
								%li
									%a{"data-toggle" => "tab", :href => "#write_reviews",:class => "write-review"} Write Reviews
							#my-tab-content.tab-content
								#overview.tab-pane.active
									.span12.search-conditions-box
										.row
											.overview-title
												%p Employer Overview 											
										.row
											.overview-item{:style=>"margin-bottom: 20px;"}
												.span3
													%label 
														Previous H-1B History :
												.span2
													=overview_item @search_h1bemp.prevh1Flag
										.row
											.overview-item
												.span3
													%label 
														H-1B Approval Rate :
												.span2
													=overview_item @search_h1bemp.h1bARateFlag
										.row
											.overview-item
												.span3
													%label 
														E-Verified :
												.span2
													=overview_item @search_h1bemp.everifiedFlag
										.row
											.overview-item
												.span3
													%label 
														Previous GC History :
												.span2
													=overview_item @search_h1bemp.prevGCFlag
										.row
											.overview-item
												.span3
													%label 
														GC Approval Rate :
												.span2
													=overview_item @search_h1bemp.gcARateFlag
								#h1b_gcstats.tab-pane{:style=>"height:720px;"}
									.span12.h1b-gcstats
										.chart-content
											.row.stats-title
												%p H-1B and Green cards Statistics											
											.row
												.span10
													#h1b_chart												
											.row{:style=>"margin-top:40px;"}
												.span10
													#gc_chart											
										.chart-table-content
								#top_jobs.tab-pane{:style=>"height:720px;"}
									.span12.top-jobs
										.row.top-hired
											.span12
												#top_hired
											.span12
												%table.table.table-hover
													%thead
														%tr
															%th Title
															%th Total Hired
															%th Avg Salary
															%th Rank
													%tbody
														-@top_hired_table_data.each do |t_hired_data|
															%tr
																%td=t_hired_data[0]
																%td=t_hired_data[1]
																%td=t_hired_data[2]
																%td=t_hired_data[3]
										.row.top-avg
											.span12
												#top_avg
											.span12
												%table.table.table-striped.table-hover
													%thead
														%tr
															%th Title
															%th Total Hired
															%th Avg Salary
															%th Rank
													%tbody
														-@top_avg_table_data.each do |t_avg_data|
															%tr
																%td=t_avg_data[0]
																%td=t_avg_data[1]
																%td=t_avg_data[2]
																%td=t_avg_data[3]
								#reviews.tab-pane
									.span12.reviews
										.row
											.review-title
												%p Employer Review
										.row
											.span3
												=@search_h1bemp.employerName
											.span2
												=ratings_for @search_h1bemp, :static, :dimension=>:company, :remote_options =>{:url => rate_search_employer_path(@search_h1bemp)}
											.span2
												%label (613 reviews)

								#write_reviews.tab-pane
									.span10.offset1.reviews
										.row
											.review-title
												%p Your overall rating of this company
										.row
											.span3.offset1
												=ratings_for @search_h1bemp, :dimension=>:company, :show_user_rating=> true, :remote_options =>{:url => rate_search_employer_path(@search_h1bemp)}
											.span2
												%label Click to Rate
										.row
											.span3.offset1
												%label Paid On Time
											.span1
											.span1
										.row
											.span3.offset1
												%label Placements
											.span1
											.span1
										.row
											.span3.offset1
												%label H-1B and Legal Support
											.span1
											.span1
										.row							
											.span10.offset1				
												#comments_content
													=render :partial => "comments"
											.row
												.span3.offset1
													%label Comments
											.row
												.span10.offset1
													= form_tag add_comment_search_employer_path(@search_h1bemp), :method => :post, :id=>"comment_form" do
														.row
															= text_area_tag :comment, params[:comment], :placeholder => "Please input comment", :value=> params[:comment].presence || "", :rows=> 5, :style=>"width: 100%"
														.row
															.span3.offset5
																%a{:class=>"m-btn blue post-comment"} Post Comment



:javascript 
	var cur_tab = 0
	$('.secodary ul li').eq(1).addClass('current-tab');
	$('.secodary ul li').eq(0).removeClass('current-tab');

	$("#tabs li").each(function(){
		$(this).removeClass("active");
	});
	$("#my-tab-content div").each(function(){
		$(this).removeClass("active");
	});	
	
	$("#tabs li").eq(cur_tab).addClass("active");
	$("#my-tab-content div.tab-pane").eq(cur_tab).addClass("active");
	var availableTags = #{@h1bemp_names}
	
	$( "#h1bemp_name" ).autocomplete({
		source: availableTags
	});

	google.load("visualization", "1", {packages:["corechart"]});
	google.setOnLoadCallback(drawChart);
	var gc_chart_data = #{@gc_chart_data}
	var h1b_chart_data = #{@h1b_chart_data}
	var top_hire_data = #{@top_hired_data}
	var top_avg_data = #{@top_avg_data}
	function drawChart() {
		var data = google.visualization.arrayToDataTable(gc_chart_data);
		var options = {
			title:"GC Filings Per Year",
			width:900, height:300,
			vAxis: {title: "Year"},
			hAxis: {title: "No. of GC Filings"},
			chartArea: {width: '60%'},
			isStacked: 1,
			series: [{color: 'Green', visibleInLegend: true}, {color: '#dc3912', visibleInLegend: true},{color: '#3366cc', visibleInLegend: true},{color: 'orange', visibleInLegend: true}]
		};
		var gc_chart = new google.visualization.BarChart(document.getElementById('gc_chart'));
		gc_chart.draw(data, options);

		data = google.visualization.arrayToDataTable(h1b_chart_data);
		options = {
			title:"LCA Filings (H-1B) Per Year",
			width:900, height:300,
			vAxis: {title: "Year"},
			hAxis: {title: "No. of LCA Filings - H-1B"},
			chartArea: {width: '60%'},
			isStacked: 1,
			series: [{color: 'Green', visibleInLegend: true}, {color: '#dc3912', visibleInLegend: true},{color: '#3366cc', visibleInLegend: true},{color: 'orange', visibleInLegend: true}]
		};
		var h1b_chart = new google.visualization.BarChart(document.getElementById('h1b_chart'));
		h1b_chart.draw(data, options);

		data = google.visualization.arrayToDataTable(top_hire_data);
		options = {
			title:"Total Jobs Hired",
			width:960, height:300,
			vAxis: {title: "Title"},
			hAxis: {title: "Total Hired"},
			chartArea: {left: 350, top: 30, width: '45%'}
		};
		var top_job_chart = new google.visualization.BarChart(document.getElementById('top_hired'));
		top_job_chart.draw(data, options);

		data = google.visualization.arrayToDataTable(top_avg_data);
		options = {
			title:"Total Jobs - Avg Salary",
			width:960, height:300,
			vAxis: {title: "Job Title"},
			hAxis: {title: "Salary(in $)"},
			chartArea: {left: 400, top: 30, width: '45%'}
		};
		var top_avg_chart = new google.visualization.BarChart(document.getElementById('top_avg'));
		top_avg_chart.draw(data, options);		
	}
	isLoged = "#{user_signed_in?}"

	$("a.write-review").click(function(){
		if(isLoged == "false"){
			document.location.href = "/users/sign_in";
		}
	});
	$("a.post-comment").click(function(){
		var url_ajax = $("#comment_form").attr("action");
		var content = $("#comment").val();
		if(content.length < 10){
			$("#comment").focus();
			return;
		} 
		
		$.ajax({
			url :url_ajax,
			beforeSend : function(xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
			type: "POST",
			data: 'content=' + content,
			dataType:'script',
			success :function(){console.log("success");}
		});
		return false;
	});

